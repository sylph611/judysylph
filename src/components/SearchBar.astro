---
interface Props {
  lang: string;
  placeholder?: string;
}

const { lang, placeholder } = Astro.props;
const defaultPlaceholder = lang === 'ko' ? '테스트나 도구 검색...' : 'Search tests or tools...';
---

<div class="search-container relative max-w-md mx-auto mb-8">
  <div class="relative">
    <input
      type="text"
      id="search-input"
      class="w-full px-4 py-3 pl-12 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 dark:text-white placeholder-gray-500"
      placeholder={placeholder || defaultPlaceholder}
      aria-label={lang === 'ko' ? '테스트 및 도구 검색' : 'Search tests and tools'}
      aria-controls="search-results"
      aria-autocomplete="list"
    />
    <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>
    <button
      id="search-clear"
      type="button"
      class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden"
      aria-label={lang === 'ko' ? '검색어 지우기' : 'Clear search'}
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- Search Results Dropdown -->
  <div
    id="search-results"
    class="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 hidden z-50 max-h-96 overflow-y-auto"
    role="listbox"
    aria-label={lang === 'ko' ? '검색 결과' : 'Search results'}
  >
    <!-- Loading Skeleton -->
    <div id="search-loading" class="hidden">
      {[1, 2, 3].map(() => (
        <div class="flex items-center gap-3 p-3">
          <div class="skeleton w-8 h-8 rounded-lg"></div>
          <div class="flex-1">
            <div class="skeleton h-4 w-32 rounded mb-2"></div>
            <div class="skeleton h-3 w-48 rounded"></div>
          </div>
          <div class="skeleton h-5 w-12 rounded-full"></div>
        </div>
      ))}
    </div>
    <div id="search-results-content"></div>
    <div id="search-no-results" class="hidden p-4 text-center text-gray-500">
      {lang === 'ko' ? '검색 결과가 없습니다' : 'No results found'}
    </div>
  </div>
</div>

<style>
  .skeleton {
    background: linear-gradient(
      90deg,
      rgb(229 231 235) 25%,
      rgb(243 244 246) 50%,
      rgb(229 231 235) 75%
    );
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }

  :global(.dark) .skeleton {
    background: linear-gradient(
      90deg,
      rgb(55 65 81) 25%,
      rgb(75 85 99) 50%,
      rgb(55 65 81) 75%
    );
    background-size: 200% 100%;
  }

  @keyframes shimmer {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }
</style>

<script>
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchClear = document.getElementById('search-clear');
  const searchResults = document.getElementById('search-results');
  const searchResultsContent = document.getElementById('search-results-content');
  const searchNoResults = document.getElementById('search-no-results');
  const searchLoading = document.getElementById('search-loading');
  let searchTimeout: ReturnType<typeof setTimeout> | null = null;

  // Get all searchable items
  const testCards = document.querySelectorAll('.test-card');
  const toolCards = document.querySelectorAll('[data-tool-slug]');

  interface SearchItem {
    type: 'test' | 'tool';
    slug: string;
    title: string;
    description: string;
    emoji: string;
    element: Element;
  }

  const searchItems: SearchItem[] = [];

  // Collect test items
  testCards.forEach(card => {
    const link = card.querySelector('a');
    const title = card.querySelector('h3')?.textContent || '';
    const description = card.querySelector('p')?.textContent || '';
    const emoji = card.querySelector('.text-4xl')?.textContent || '';
    const slug = link?.getAttribute('href')?.split('/test/')[1] || '';

    searchItems.push({
      type: 'test',
      slug,
      title,
      description,
      emoji,
      element: card
    });
  });

  // Collect tool items
  toolCards.forEach(card => {
    const slug = card.getAttribute('data-tool-slug') || '';
    const title = card.querySelector('h3')?.textContent || '';
    const description = card.querySelector('p')?.textContent || '';
    const emoji = card.querySelector('.text-3xl')?.textContent || '';

    searchItems.push({
      type: 'tool',
      slug,
      title,
      description,
      emoji,
      element: card
    });
  });

  function performSearch(query: string) {
    const normalizedQuery = query.toLowerCase().trim();

    if (!normalizedQuery) {
      searchResults?.classList.add('hidden');
      // Show all items
      searchItems.forEach(item => {
        (item.element as HTMLElement).style.display = '';
      });
      return;
    }

    const matches = searchItems.filter(item =>
      item.title.toLowerCase().includes(normalizedQuery) ||
      item.description.toLowerCase().includes(normalizedQuery)
    );

    // Filter in-page items
    searchItems.forEach(item => {
      if (matches.includes(item)) {
        (item.element as HTMLElement).style.display = '';
      } else {
        (item.element as HTMLElement).style.display = 'none';
      }
    });

    // Show dropdown results
    if (searchResultsContent && searchNoResults && searchResults) {
      if (matches.length > 0) {
        const lang = document.documentElement.lang || 'ko';
        searchResultsContent.innerHTML = matches.slice(0, 8).map(item => `
          <a
            href="/${lang}/${item.type === 'test' ? 'test' : 'tools'}/${item.slug}"
            class="flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
          >
            <span class="text-2xl">${item.emoji}</span>
            <div class="flex-1 min-w-0">
              <div class="font-medium text-gray-900 dark:text-white truncate">${item.title}</div>
              <div class="text-sm text-gray-500 truncate">${item.description}</div>
            </div>
            <span class="text-xs px-2 py-1 rounded-full ${item.type === 'test' ? 'bg-primary-100 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300' : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300'}">
              ${item.type === 'test' ? (lang === 'ko' ? '테스트' : 'Test') : (lang === 'ko' ? '도구' : 'Tool')}
            </span>
          </a>
        `).join('');
        searchNoResults.classList.add('hidden');
        searchResultsContent.classList.remove('hidden');
      } else {
        searchResultsContent.classList.add('hidden');
        searchNoResults.classList.remove('hidden');
      }
      searchResults.classList.remove('hidden');
    }
  }

  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value;
    searchClear?.classList.toggle('hidden', !query);

    // Show loading skeleton briefly for better UX
    if (query.trim()) {
      searchLoading?.classList.remove('hidden');
      searchResultsContent?.classList.add('hidden');
      searchNoResults?.classList.add('hidden');
      searchResults?.classList.remove('hidden');
    }

    // Debounce search
    if (searchTimeout) clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchLoading?.classList.add('hidden');
      performSearch(query);
    }, 150);
  });

  searchClear?.addEventListener('click', () => {
    if (searchInput) {
      searchInput.value = '';
      searchClear.classList.add('hidden');
      performSearch('');
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!searchInput?.contains(e.target as Node) && !searchResults?.contains(e.target as Node)) {
      searchResults?.classList.add('hidden');
    }
  });

  // Keyboard navigation
  searchInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      searchResults?.classList.add('hidden');
      searchInput.blur();
    }
  });
</script>
