---
import Layout from '../../../../layouts/Layout.astro';
import Result from '../../../../components/Result.astro';
import ShareButtons from '../../../../components/ShareButtons.astro';
import ResultActions from '../../../../components/ResultActions.astro';
import AdBanner from '../../../../components/AdBanner.astro';
import TestCard from '../../../../components/TestCard.astro';
import Confetti from '../../../../components/Confetti.astro';
import { getTest, getAllTests, getRecommendedTests } from '../../../../utils/tests';

export function getStaticPaths() {
  const tests = getAllTests('ko');
  const paths = [];

  tests.forEach((test) => {
    test.results.forEach((result) => {
      paths.push({
        params: { slug: test.slug, type: result.type },
      });
    });
  });

  return paths;
}

const { slug, type } = Astro.params;
const lang = 'ko';
const test = getTest(slug, lang);

if (!test) {
  return Astro.redirect('/ko');
}

const result = test.results.find(r => r.type === type);

if (!result) {
  return Astro.redirect(`/ko/test/${slug}`);
}

const pageTitle = `${result.title} - ${test.title} | JudySylph`;
const pageDescription = `ë‚˜ì˜ ê²°ê³¼: ${result.title}. ${result.description.substring(0, 100)}...`;
const siteUrl = Astro.site?.toString().replace(/\/$/, '') || 'https://judysylph.com';
const pageUrl = `${siteUrl}/ko/result/${slug}/${type}`;
const ogImage = `${siteUrl}/og/${slug}/${type}.svg`;

const otherTests = getRecommendedTests(lang, slug, 3);

// JSON-LD structured data
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Quiz",
  "name": test.title,
  "description": test.description,
  "about": {
    "@type": "Thing",
    "name": "Personality Test"
  }
};
---

<Layout title={pageTitle} description={pageDescription} ogImage={ogImage}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </Fragment>

  <!-- Confetti Animation -->
  <Confetti />

  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Ad Banner Top -->
    <AdBanner slot="result" className="mb-8" />

    <!-- Result Component -->
    <Result
      type={result.type}
      title={result.title}
      emoji={result.emoji}
      description={result.description}
      traits={result.traits}
      advice={result.advice}
      compatibility={result.compatibility}
      lang={lang}
    />

    <!-- Share Buttons -->
    <ShareButtons
      url={pageUrl}
      title={`ë‚˜ì˜ ${test.title} ê²°ê³¼: ${result.title} ${result.emoji}`}
      description={result.description}
      lang={lang}
    />

    <!-- Image Save & QR Code -->
    <ResultActions
      url={pageUrl}
      resultTitle={result.title}
      resultEmoji={result.emoji}
      testTitle={test.title}
      lang={lang}
    />

    <!-- Compare with Friend -->
    <div class="mt-8 p-4 bg-gradient-to-r from-primary-50 to-secondary-50 dark:from-primary-900/20 dark:to-secondary-900/20 rounded-2xl">
      <div class="text-center">
        <p class="text-gray-700 dark:text-gray-300 mb-3">ì¹œêµ¬ì™€ ê²°ê³¼ë¥¼ ë¹„êµí•´ë³´ì„¸ìš”!</p>
        <button
          id="compare-btn"
          type="button"
          class="px-6 py-3 bg-gradient-to-r from-primary-500 to-secondary-500 text-white rounded-xl font-medium hover:opacity-90 transition-opacity"
          data-slug={slug}
          data-type={type}
        >
          ğŸ¤ ì¹œêµ¬ì™€ ë¹„êµí•˜ê¸°
        </button>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
      <a
        href={`/${lang}/test/${slug}`}
        class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors text-center"
      >
        ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°
      </a>
      <a
        href={`/${lang}`}
        class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-xl font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-center"
      >
        ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ ë³´ê¸°
      </a>
    </div>

    <!-- Ad Banner Bottom -->
    <AdBanner slot="result" className="mt-8" />

    <!-- Recommended Tests -->
    {otherTests.length > 0 && (
      <section class="mt-16">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2 text-center">
          ì´ í…ŒìŠ¤íŠ¸ë¥¼ í•œ ì‚¬ëŒë“¤ì´ ì¢‹ì•„í•œ í…ŒìŠ¤íŠ¸
        </h2>
        <p class="text-gray-600 dark:text-gray-400 text-center mb-6">ë¹„ìŠ·í•œ ê´€ì‹¬ì‚¬ì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          {otherTests.map((t) => (
            <TestCard
              slug={t.slug}
              title={t.title}
              description={t.description}
              emoji={t.emoji}
              questionCount={t.questionCount}
              lang={lang}
            />
          ))}
        </div>
      </section>
    )}
  </div>
  <!-- Save Result Script -->
  <script define:vars={{ testTitle: test.title, resultTitle: result.title, resultEmoji: result.emoji || test.emoji, slug, type, testEmoji: test.emoji }}>
    // Save result to localStorage
    const saveResult = () => {
      const history = JSON.parse(localStorage.getItem('testHistory') || '[]');

      const newResult = {
        id: Date.now(),
        testSlug: slug,
        testTitle: testTitle,
        testEmoji: testEmoji,
        resultType: type,
        resultTitle: resultTitle,
        resultEmoji: resultEmoji,
        date: new Date().toISOString(),
        lang: 'ko'
      };

      // Check if same test was taken recently (within 1 hour)
      const recentIndex = history.findIndex(h =>
        h.testSlug === slug &&
        h.resultType === type &&
        Date.now() - new Date(h.date).getTime() < 3600000
      );

      if (recentIndex === -1) {
        // Add new result at the beginning
        history.unshift(newResult);
        // Keep only last 50 results
        if (history.length > 50) history.pop();
        localStorage.setItem('testHistory', JSON.stringify(history));
      }
    };

    // Save on page load
    saveResult();

    // Compare button handler
    const compareBtn = document.getElementById('compare-btn');
    compareBtn?.addEventListener('click', async () => {
      const myType = compareBtn.getAttribute('data-type');
      const testSlug = compareBtn.getAttribute('data-slug');
      const compareUrl = `${window.location.origin}/ko/result/${testSlug}/compare?me=${myType}&friend=`;

      // Copy link and prompt user
      const message = 'ë§í¬ë¥¼ ë³µì‚¬í•´ì„œ ì¹œêµ¬ì—ê²Œ ë³´ë‚´ì„¸ìš”.\nì¹œêµ¬ê°€ í…ŒìŠ¤íŠ¸ë¥¼ ì™„ë£Œí•˜ë©´ ë¹„êµ ê²°ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”!\n\n' + compareUrl + '[ì¹œêµ¬ê²°ê³¼íƒ€ì…]';

      try {
        await navigator.clipboard.writeText(compareUrl);
        alert('ë¹„êµ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì¹œêµ¬ì—ê²Œ í…ŒìŠ¤íŠ¸ ë§í¬ë¥¼ ë³´ë‚´ê³ , ê²°ê³¼ë¥¼ ì•Œë ¤ë‹¬ë¼ê³  í•˜ì„¸ìš”.\nê·¸ ë‹¤ìŒ ë³µì‚¬ëœ ë§í¬ì˜ [friend=] ë’¤ì— ì¹œêµ¬ì˜ ê²°ê³¼ íƒ€ì…ì„ ì¶”ê°€í•˜ë©´ ë¹„êµ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
      } catch (err) {
        // Prompt fallback
        const friendType = prompt('ì¹œêµ¬ì˜ ê²°ê³¼ íƒ€ì…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: dog, cat ë“±):');
        if (friendType) {
          window.location.href = `/ko/result/${testSlug}/compare?me=${myType}&friend=${friendType}`;
        }
      }
    });
  </script>
</Layout>
