---
import Layout from '../../../layouts/Layout.astro';
import { getTool } from '../../../utils/tools';

const lang = 'ko';
const tool = getTool('salary-calculator', lang);
---

<Layout title={`${tool?.title} | JudySylph`} description={tool?.description}>
  <div class="max-w-4xl mx-auto px-4 py-8">
    <div class="text-center mb-8">
      <div class="text-5xl mb-4">{tool?.emoji}</div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{tool?.title}</h1>
      <p class="text-gray-600 dark:text-gray-400">{tool?.description}</p>
      <p class="text-sm text-primary-600 dark:text-primary-400 mt-2">2026년 세율 기준</p>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
      <form id="calc-form" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">국가</label>
          <select id="country" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            <option value="US">미국 (United States)</option>
            <option value="UK">영국 (United Kingdom)</option>
            <option value="CA">캐나다 (Canada)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">연봉 (해당 국가 통화)</label>
          <input type="text" id="salary" placeholder="100,000" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">신고 상태</label>
          <select id="status" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            <option value="single">독신 (Single)</option>
            <option value="married">기혼 (Married)</option>
          </select>
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">계산하기</button>
      </form>

      <div id="result-area" class="mt-8 hidden">
        <div class="bg-gradient-to-r from-primary-50 to-secondary-50 dark:from-primary-900/20 dark:to-secondary-900/20 rounded-xl p-6">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">계산 결과 <span id="r-currency" class="text-sm font-normal text-gray-500"></span></h3>
          <div class="space-y-3 mb-4">
            <div class="flex justify-between bg-white dark:bg-gray-800 rounded-lg p-3"><span class="text-gray-600 dark:text-gray-400">연봉</span><span id="r-gross" class="font-medium">-</span></div>
            <div class="flex justify-between bg-white dark:bg-gray-800 rounded-lg p-3"><span class="text-gray-600 dark:text-gray-400">연방/국세</span><span id="r-federal" class="font-medium text-red-500">-</span></div>
            <div class="flex justify-between bg-white dark:bg-gray-800 rounded-lg p-3"><span class="text-gray-600 dark:text-gray-400">사회보장세</span><span id="r-social" class="font-medium text-red-500">-</span></div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 text-center">
              <div class="text-sm text-gray-600 dark:text-gray-400">연 실수령액</div>
              <div id="r-net-year" class="text-xl font-bold text-primary-600 dark:text-primary-400">-</div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 text-center">
              <div class="text-sm text-gray-600 dark:text-gray-400">월 실수령액</div>
              <div id="r-net-month" class="text-xl font-bold text-primary-600 dark:text-primary-400">-</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-6 bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4">
      <h4 class="font-bold text-blue-800 dark:text-blue-200 mb-2">2026년 세율 정보</h4>
      <p class="text-sm text-blue-700 dark:text-blue-300">US: 10~37% / UK: 0~45% / CA: 15~33% (연방)</p>
    </div>
    <div class="mt-8 text-center"><a href="/ko/tools" class="text-primary-600 dark:text-primary-400 hover:underline">← 도구 목록</a></div>
  </div>
</Layout>

<script>
  const form = document.getElementById('calc-form') as HTMLFormElement;
  const salaryInput = document.getElementById('salary') as HTMLInputElement;

  salaryInput?.addEventListener('input', e => {
    const v = (e.target as HTMLInputElement).value.replace(/\D/g,'');
    (e.target as HTMLInputElement).value = Number(v).toLocaleString();
  });

  // 2026 Tax brackets by country and filing status
  type Bracket = { limit: number; rate: number };
  type TaxConfig = {
    currency: string;
    symbol: string;
    single: Bracket[];
    married: Bracket[];
    calcSocial: (income: number) => number;
  };

  const taxData: Record<string, TaxConfig> = {
    US: {
      currency: 'USD',
      symbol: '$',
      single: [
        { limit: 11600, rate: 0.10 },
        { limit: 47150, rate: 0.12 },
        { limit: 100525, rate: 0.22 },
        { limit: 191950, rate: 0.24 },
        { limit: 243725, rate: 0.32 },
        { limit: 609350, rate: 0.35 },
        { limit: Infinity, rate: 0.37 }
      ],
      married: [
        { limit: 23200, rate: 0.10 },
        { limit: 94300, rate: 0.12 },
        { limit: 201050, rate: 0.22 },
        { limit: 383900, rate: 0.24 },
        { limit: 487450, rate: 0.32 },
        { limit: 731200, rate: 0.35 },
        { limit: Infinity, rate: 0.37 }
      ],
      calcSocial: (income: number) => {
        const ssWageBase = 176100; // 2026 Social Security wage base
        const ssRate = 0.062;
        const medicareRate = 0.0145;
        const additionalMedicareThreshold = 200000;
        const additionalMedicareRate = 0.009;

        const ssTax = Math.min(income, ssWageBase) * ssRate;
        let medicareTax = income * medicareRate;
        if (income > additionalMedicareThreshold) {
          medicareTax += (income - additionalMedicareThreshold) * additionalMedicareRate;
        }
        return Math.round(ssTax + medicareTax);
      }
    },
    UK: {
      currency: 'GBP',
      symbol: '£',
      single: [
        { limit: 12570, rate: 0 },
        { limit: 50270, rate: 0.20 },
        { limit: 125140, rate: 0.40 },
        { limit: Infinity, rate: 0.45 }
      ],
      married: [
        { limit: 12570, rate: 0 },
        { limit: 50270, rate: 0.20 },
        { limit: 125140, rate: 0.40 },
        { limit: Infinity, rate: 0.45 }
      ],
      calcSocial: (income: number) => {
        // UK National Insurance 2026
        const lowerThreshold = 12570;
        const upperThreshold = 50270;
        const mainRate = 0.12;
        const upperRate = 0.02;

        if (income <= lowerThreshold) return 0;
        let ni = 0;
        if (income <= upperThreshold) {
          ni = (income - lowerThreshold) * mainRate;
        } else {
          ni = (upperThreshold - lowerThreshold) * mainRate;
          ni += (income - upperThreshold) * upperRate;
        }
        return Math.round(ni);
      }
    },
    CA: {
      currency: 'CAD',
      symbol: '$',
      single: [
        { limit: 55867, rate: 0.15 },
        { limit: 111733, rate: 0.205 },
        { limit: 173205, rate: 0.26 },
        { limit: 246752, rate: 0.29 },
        { limit: Infinity, rate: 0.33 }
      ],
      married: [
        { limit: 55867, rate: 0.15 },
        { limit: 111733, rate: 0.205 },
        { limit: 173205, rate: 0.26 },
        { limit: 246752, rate: 0.29 },
        { limit: Infinity, rate: 0.33 }
      ],
      calcSocial: (income: number) => {
        // Canada CPP + EI 2026
        const cppMax = 73200;
        const cppExempt = 3500;
        const cppRate = 0.0595;
        const eiMax = 65700;
        const eiRate = 0.0166;

        const cppEarnings = Math.min(Math.max(income - cppExempt, 0), cppMax - cppExempt);
        const cpp = cppEarnings * cppRate;
        const ei = Math.min(income, eiMax) * eiRate;
        return Math.round(cpp + ei);
      }
    }
  };

  function calcTax(income: number, brackets: Bracket[]): number {
    let tax = 0;
    let prev = 0;
    for (const bracket of brackets) {
      const taxableInBracket = Math.min(income, bracket.limit) - prev;
      if (taxableInBracket > 0) {
        tax += taxableInBracket * bracket.rate;
      }
      if (income <= bracket.limit) break;
      prev = bracket.limit;
    }
    return Math.round(tax);
  }

  form?.addEventListener('submit', e => {
    e.preventDefault();
    const country = (document.getElementById('country') as HTMLSelectElement).value;
    const status = (document.getElementById('status') as HTMLSelectElement).value;
    const salary = parseInt(salaryInput.value.replace(/,/g,''));
    const data = taxData[country];

    const brackets = status === 'married' ? data.married : data.single;
    const federal = calcTax(salary, brackets);
    const social = data.calcSocial(salary);
    const netYear = salary - federal - social;
    const netMonth = Math.round(netYear / 12);

    document.getElementById('result-area')?.classList.remove('hidden');
    document.getElementById('r-currency')!.textContent = `(${data.currency})`;
    document.getElementById('r-gross')!.textContent = data.symbol + salary.toLocaleString();
    document.getElementById('r-federal')!.textContent = '-' + data.symbol + federal.toLocaleString();
    document.getElementById('r-social')!.textContent = '-' + data.symbol + social.toLocaleString();
    document.getElementById('r-net-year')!.textContent = data.symbol + netYear.toLocaleString();
    document.getElementById('r-net-month')!.textContent = data.symbol + netMonth.toLocaleString();
  });
</script>
