---
import Layout from '../../../layouts/Layout.astro';
import { getTool, generateToolBreadcrumbSchema, generateToolHowToSchema, calculatorSteps, getToolStepType } from '../../../utils/tools';

const lang = 'ko';
const tool = getTool('dday-calculator', lang);

const siteUrl = 'https://judysylph.com';
const stepType = getToolStepType('dday-calculator');
const steps = calculatorSteps['ko'][stepType];

const webAppSchema = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": tool?.title,
  "description": tool?.description,
  "applicationCategory": "FinanceApplication",
  "operatingSystem": "All",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "KRW" }
};

const breadcrumbSchema = tool ? generateToolBreadcrumbSchema(tool, 'ko', siteUrl) : null;
const howToSchema = tool ? generateToolHowToSchema(tool, 'ko', siteUrl, steps) : null;

const jsonLd = [webAppSchema, breadcrumbSchema, howToSchema].filter(Boolean);
---

<Layout title={`${tool?.title} | JudySylph`} description={tool?.description} jsonLd={jsonLd}>
  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="text-5xl mb-4">{tool?.emoji}</div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{tool?.title}</h1>
      <p class="text-gray-600 dark:text-gray-400">{tool?.description}</p>
    </div>

    <!-- Tool Area -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
      <div class="space-y-6">
        <div>
          <label for="target-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            목표 날짜 선택
          </label>
          <input
            type="date"
            id="target-date"
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          />
        </div>

        <div>
          <label for="event-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            이벤트 이름 (선택)
          </label>
          <input
            type="text"
            id="event-name"
            placeholder="예: 여행, 시험, 기념일"
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          />
        </div>

        <button
          id="calculate-btn"
          type="button"
          class="w-full px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors"
        >
          계산하기
        </button>
      </div>

      <!-- Result -->
      <div id="result-area" class="mt-8 hidden">
        <div class="text-center p-8 bg-gradient-to-br from-primary-500 to-secondary-500 rounded-2xl text-white">
          <div id="event-display" class="text-lg mb-2 opacity-90"></div>
          <div id="dday-result" class="text-6xl font-bold mb-4"></div>
          <div id="date-display" class="opacity-90"></div>
        </div>

        <div class="mt-6 grid grid-cols-3 gap-4 text-center">
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4">
            <div id="weeks" class="text-2xl font-bold text-primary-600 dark:text-primary-400">0</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">주</div>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4">
            <div id="hours" class="text-2xl font-bold text-primary-600 dark:text-primary-400">0</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">시간</div>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4">
            <div id="minutes" class="text-2xl font-bold text-primary-600 dark:text-primary-400">0</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">분</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Info Section -->
    <div class="mt-8 space-y-4">
      <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-5">
        <h2 class="font-bold text-blue-800 dark:text-blue-200 mb-3">D-Day 표기법</h2>
        <ul class="text-sm text-blue-700 dark:text-blue-300 space-y-2">
          <li>• <strong>D-Day</strong>: 목표일 당일 (기준일)</li>
          <li>• <strong>D-숫자</strong>: 목표일까지 남은 일수 (예: D-30 = 30일 남음)</li>
          <li>• <strong>D+숫자</strong>: 기준일로부터 지난 일수 (예: D+100 = 100일 지남)</li>
          <li>• D-Day는 제2차 세계대전 노르망디 상륙작전에서 유래되었습니다.</li>
        </ul>
      </div>

      <div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-5">
        <h2 class="font-bold text-green-800 dark:text-green-200 mb-3">D-Day 계산이 필요한 순간</h2>
        <div class="grid grid-cols-2 gap-4 text-sm text-green-700 dark:text-green-300">
          <div>
            <p>• 시험 D-Day (수능, 자격증)</p>
            <p>• 결혼식, 생일 카운트다운</p>
            <p>• 여행 출발일까지</p>
            <p>• 프로젝트 마감일</p>
          </div>
          <div>
            <p>• 연인과의 기념일 (100일, 1주년)</p>
            <p>• 출산 예정일</p>
            <p>• 퇴사일, 입사일</p>
            <p>• 중요 계약 만료일</p>
          </div>
        </div>
      </div>

      <div class="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-5">
        <h2 class="font-bold text-purple-800 dark:text-purple-200 mb-3">주요 기념일 계산</h2>
        <ul class="text-sm text-purple-700 dark:text-purple-300 space-y-1">
          <li>• <strong>100일</strong>: 연인 사이 첫 번째 주요 기념일</li>
          <li>• <strong>200일, 300일</strong>: 100일 단위 기념일</li>
          <li>• <strong>1주년 (365일)</strong>: 만 1년 기념일</li>
          <li>• <strong>1,000일</strong>: 약 2년 9개월, 특별한 기념일</li>
          <li>• <strong>10,000일</strong>: 약 27년 4개월, 인생 기념일</li>
        </ul>
      </div>
    </div>

    <!-- Back Link -->
    <div class="mt-8 text-center">
      <a href="/ko/tools" class="text-primary-600 dark:text-primary-400 hover:underline">
        ← 도구 목록으로 돌아가기
      </a>
    </div>
  </div>
</Layout>

<script>
  const targetDateInput = document.getElementById('target-date') as HTMLInputElement;
  const eventNameInput = document.getElementById('event-name') as HTMLInputElement;
  const calculateBtn = document.getElementById('calculate-btn');
  const resultArea = document.getElementById('result-area');
  const eventDisplay = document.getElementById('event-display');
  const ddayResult = document.getElementById('dday-result');
  const dateDisplay = document.getElementById('date-display');
  const weeksEl = document.getElementById('weeks');
  const hoursEl = document.getElementById('hours');
  const minutesEl = document.getElementById('minutes');

  // Set default date to today
  const today = new Date();
  targetDateInput.value = today.toISOString().split('T')[0];

  function formatDate(date: Date): string {
    return date.toLocaleDateString('ko-KR', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'long'
    });
  }

  function calculate() {
    const targetDate = new Date(targetDateInput.value);
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    targetDate.setHours(0, 0, 0, 0);

    const diffTime = targetDate.getTime() - now.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    const eventName = eventNameInput.value || '목표일';

    resultArea?.classList.remove('hidden');

    if (eventDisplay) eventDisplay.textContent = eventName;
    if (dateDisplay) dateDisplay.textContent = formatDate(targetDate);

    if (diffDays > 0) {
      if (ddayResult) ddayResult.textContent = `D-${diffDays}`;
    } else if (diffDays < 0) {
      if (ddayResult) ddayResult.textContent = `D+${Math.abs(diffDays)}`;
    } else {
      if (ddayResult) ddayResult.textContent = 'D-Day!';
    }

    const absDays = Math.abs(diffDays);
    const weeks = Math.floor(absDays / 7);
    const hours = absDays * 24;
    const minutes = hours * 60;

    if (weeksEl) weeksEl.textContent = weeks.toLocaleString();
    if (hoursEl) hoursEl.textContent = hours.toLocaleString();
    if (minutesEl) minutesEl.textContent = minutes.toLocaleString();
  }

  calculateBtn?.addEventListener('click', calculate);
  targetDateInput?.addEventListener('change', calculate);

  // Initial calculation
  calculate();
</script>
