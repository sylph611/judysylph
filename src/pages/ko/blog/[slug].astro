---
import Layout from '../../../layouts/Layout.astro';
import { getAllPosts, getPost, getRecentPosts } from '../../../utils/blog';

export function getStaticPaths() {
  const posts = getAllPosts('ko');
  return posts.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const lang = 'ko';
const post = getPost(slug, lang);

if (!post) {
  return Astro.redirect('/ko/blog');
}

const recentPosts = getRecentPosts(lang, 3).filter(p => p.slug !== slug);

const pageTitle = `${post.title} | JudySylph 블로그`;
const siteUrl = Astro.site?.toString().replace(/\/$/, '') || 'https://judysylph.com';

// Convert markdown-like content to HTML
function parseContent(content: string): string {
  return content
    .replace(/## (.*)/g, '<h2 class="text-2xl font-bold text-gray-900 dark:text-white mt-8 mb-4">$1</h2>')
    .replace(/### (.*)/g, '<h3 class="text-xl font-bold text-gray-900 dark:text-white mt-6 mb-3">$1</h3>')
    .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
    .replace(/- (.*)/g, '<li class="ml-4 text-gray-700 dark:text-gray-300">$1</li>')
    .replace(/(\d+)\. \*\*(.*?)\*\*: (.*)/g, '<div class="my-2"><span class="font-bold text-primary-600 dark:text-primary-400">$1. $2</span>: $3</div>')
    .replace(/(\d+)\. \*\*(.*?)\*\*/g, '<div class="my-2 font-bold text-primary-600 dark:text-primary-400">$1. $2</div>')
    .replace(/\n\n/g, '</p><p class="text-gray-700 dark:text-gray-300 leading-relaxed mb-4">')
    .replace(/\n/g, '<br>');
}
---

<Layout title={pageTitle} description={post.description}>
  <article class="max-w-3xl mx-auto px-4 py-8">
    <!-- Header -->
    <header class="text-center mb-8">
      <div class="text-6xl mb-4">{post.emoji}</div>
      <div class="flex items-center justify-center gap-3 mb-4">
        <span class="text-sm px-3 py-1 bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 rounded-full">
          {post.category}
        </span>
        <span class="text-sm text-gray-500">{post.readingTime}분 읽기</span>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
        {post.title}
      </h1>
      <p class="text-lg text-gray-600 dark:text-gray-400 mb-4">
        {post.description}
      </p>
      <time class="text-sm text-gray-500">
        {new Date(post.publishedAt).toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}
      </time>
    </header>

    <!-- Content -->
    <div class="prose prose-lg dark:prose-invert max-w-none">
      <p class="text-gray-700 dark:text-gray-300 leading-relaxed mb-4">
        <Fragment set:html={parseContent(post.content)} />
      </p>
    </div>

    <!-- Share -->
    <div class="mt-12 p-6 bg-gray-50 dark:bg-gray-800 rounded-2xl text-center">
      <p class="text-gray-600 dark:text-gray-400 mb-4">이 글이 도움이 되셨나요?</p>
      <div class="flex justify-center gap-3">
        <button
          onclick={`navigator.share ? navigator.share({title: '${post.title}', url: window.location.href}) : navigator.clipboard.writeText(window.location.href).then(() => alert('링크가 복사되었습니다!'))`}
          class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
        >
          공유하기
        </button>
      </div>
    </div>

    <!-- Related Posts -->
    {recentPosts.length > 0 && (
      <section class="mt-12">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">다른 글 읽기</h2>
        <div class="space-y-4">
          {recentPosts.map((p) => (
            <a
              href={`/ko/blog/${p.slug}`}
              class="flex items-center gap-4 p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary-300 dark:hover:border-primary-600 transition-colors"
            >
              <span class="text-2xl">{p.emoji}</span>
              <div>
                <h3 class="font-medium text-gray-900 dark:text-white">{p.title}</h3>
                <p class="text-sm text-gray-500">{p.readingTime}분 읽기</p>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- Back Link -->
    <div class="mt-12 text-center">
      <a href="/ko/blog" class="text-primary-600 dark:text-primary-400 hover:underline">
        ← 블로그 목록으로
      </a>
    </div>
  </article>
</Layout>
