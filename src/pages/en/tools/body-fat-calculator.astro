---
import Layout from '../../../layouts/Layout.astro';
import { getTool, generateToolBreadcrumbSchema, generateToolHowToSchema, calculatorSteps } from '../../../utils/tools';

const lang = 'en';
const tool = getTool('body-fat-calculator', lang);

const siteUrl = 'https://judysylph.com';
const steps = calculatorSteps['en']['health'];

const webAppSchema = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": tool?.title,
  "description": tool?.description,
  "applicationCategory": "HealthApplication",
  "operatingSystem": "All",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" }
};

const breadcrumbSchema = tool ? generateToolBreadcrumbSchema(tool, 'en', siteUrl) : null;
const howToSchema = tool ? generateToolHowToSchema(tool, 'en', siteUrl, steps) : null;

const jsonLd = [webAppSchema, breadcrumbSchema, howToSchema].filter(Boolean);
---

<Layout title={`${tool?.title} | JudySylph`} description={tool?.description} jsonLd={jsonLd}>
  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="text-5xl mb-4">{tool?.emoji}</div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{tool?.title}</h1>
      <p class="text-gray-600 dark:text-gray-400">{tool?.description}</p>
    </div>

    <!-- Tool Area -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
      <form id="bodyfat-form" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="gender" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Gender
            </label>
            <select
              id="gender"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            >
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>
          <div>
            <label for="age" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Age
            </label>
            <input
              type="number"
              id="age"
              placeholder="25"
              min="10"
              max="120"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            />
          </div>
          <div>
            <label for="height" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Height (cm)
            </label>
            <input
              type="number"
              id="height"
              placeholder="170"
              min="100"
              max="250"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            />
          </div>
          <div>
            <label for="weight" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Weight (kg)
            </label>
            <input
              type="number"
              id="weight"
              placeholder="65"
              min="30"
              max="300"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            />
          </div>
          <div>
            <label for="waist" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Waist (cm)
            </label>
            <input
              type="number"
              id="waist"
              placeholder="80"
              min="40"
              max="200"
              step="0.1"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            />
          </div>
          <div>
            <label for="neck" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Neck (cm)
            </label>
            <input
              type="number"
              id="neck"
              placeholder="38"
              min="20"
              max="80"
              step="0.1"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            />
          </div>
        </div>

        <!-- Hip (for females) -->
        <div id="hip-section" class="hidden">
          <label for="hip" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Hip (cm) - Women only
          </label>
          <input
            type="number"
            id="hip"
            placeholder="95"
            min="50"
            max="200"
            step="0.1"
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          />
        </div>

        <div class="flex gap-3">
          <button
            type="submit"
            class="flex-1 px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors"
          >
            Calculate
          </button>
          <button
            type="reset"
            class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
          >
            Reset
          </button>
        </div>
      </form>

      <!-- Results -->
      <div id="result-area" class="mt-8 hidden">
        <div class="text-center mb-6">
          <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">Estimated Body Fat</div>
          <div id="bodyfat-value" class="text-5xl font-bold text-primary-600 dark:text-primary-400">0%</div>
        </div>

        <!-- Gauge -->
        <div class="relative h-8 rounded-full overflow-hidden mb-6 flex">
          <div class="flex-1 bg-blue-400" title="Essential"></div>
          <div class="flex-1 bg-green-400" title="Athlete"></div>
          <div class="flex-1 bg-yellow-400" title="Fitness"></div>
          <div class="flex-1 bg-orange-400" title="Average"></div>
          <div class="flex-1 bg-red-400" title="Obese"></div>
          <div id="gauge-indicator" class="absolute top-0 w-1 h-full bg-gray-900 dark:bg-white transition-all duration-500" style="left: 0%"></div>
        </div>

        <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mb-6" id="gauge-labels"></div>

        <div id="category-info" class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
          <h3 id="category-name" class="text-xl font-bold text-gray-900 dark:text-white mb-2"></h3>
          <p id="category-description" class="text-gray-700 dark:text-gray-300"></p>
          <div class="mt-4 grid grid-cols-2 gap-4">
            <div>
              <span class="text-sm text-gray-600 dark:text-gray-400">Fat Mass</span>
              <div id="fat-mass" class="font-medium text-gray-900 dark:text-white">0 kg</div>
            </div>
            <div>
              <span class="text-sm text-gray-600 dark:text-gray-400">Lean Mass</span>
              <div id="lean-mass" class="font-medium text-gray-900 dark:text-white">0 kg</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Back Link -->
    <div class="mt-8 text-center">
      <a href="/en/tools" class="text-primary-600 dark:text-primary-400 hover:underline">
        ‚Üê Back to Tools
      </a>
    </div>
  </div>
</Layout>

<script>
  const form = document.getElementById('bodyfat-form') as HTMLFormElement;
  const genderSelect = document.getElementById('gender') as HTMLSelectElement;
  const ageInput = document.getElementById('age') as HTMLInputElement;
  const heightInput = document.getElementById('height') as HTMLInputElement;
  const weightInput = document.getElementById('weight') as HTMLInputElement;
  const waistInput = document.getElementById('waist') as HTMLInputElement;
  const neckInput = document.getElementById('neck') as HTMLInputElement;
  const hipInput = document.getElementById('hip') as HTMLInputElement;
  const hipSection = document.getElementById('hip-section');
  const resultArea = document.getElementById('result-area');
  const bodyfatValue = document.getElementById('bodyfat-value');
  const gaugeIndicator = document.getElementById('gauge-indicator');
  const gaugeLabels = document.getElementById('gauge-labels');
  const categoryName = document.getElementById('category-name');
  const categoryDescription = document.getElementById('category-description');
  const fatMass = document.getElementById('fat-mass');
  const leanMass = document.getElementById('lean-mass');

  const categories = {
    male: [
      { max: 6, name: 'Essential Fat', desc: 'Minimum fat required for basic health functions.' },
      { max: 14, name: 'Athlete', desc: 'Athletic level body fat percentage.' },
      { max: 18, name: 'Fitness', desc: 'Healthy and fit body fat level.' },
      { max: 25, name: 'Average', desc: 'Generally healthy range of body fat.' },
      { max: 100, name: 'Obese', desc: 'Weight management may be beneficial.' }
    ],
    female: [
      { max: 14, name: 'Essential Fat', desc: 'Minimum fat required for basic health functions.' },
      { max: 21, name: 'Athlete', desc: 'Athletic level body fat percentage.' },
      { max: 25, name: 'Fitness', desc: 'Healthy and fit body fat level.' },
      { max: 32, name: 'Average', desc: 'Generally healthy range of body fat.' },
      { max: 100, name: 'Obese', desc: 'Weight management may be beneficial.' }
    ]
  };

  genderSelect?.addEventListener('change', () => {
    if (genderSelect.value === 'female') {
      hipSection?.classList.remove('hidden');
    } else {
      hipSection?.classList.add('hidden');
    }
    updateGaugeLabels();
  });

  function updateGaugeLabels() {
    const gender = genderSelect.value as 'male' | 'female';
    const cats = categories[gender];
    if (gaugeLabels) {
      gaugeLabels.innerHTML = cats.map((c, i) => {
        const prev = i === 0 ? 0 : cats[i-1].max;
        return `<span>${c.name}<br/>${prev}-${c.max}%</span>`;
      }).join('');
    }
  }

  updateGaugeLabels();

  function calculateBodyFat(gender: string, height: number, waist: number, neck: number, hip?: number): number {
    // US Navy Method
    if (gender === 'male') {
      return 495 / (1.0324 - 0.19077 * Math.log10(waist - neck) + 0.15456 * Math.log10(height)) - 450;
    } else {
      return 495 / (1.29579 - 0.35004 * Math.log10(waist + (hip || 0) - neck) + 0.22100 * Math.log10(height)) - 450;
    }
  }

  function getCategory(gender: string, bf: number) {
    const cats = categories[gender as 'male' | 'female'];
    let position = 0;
    for (let i = 0; i < cats.length; i++) {
      if (bf <= cats[i].max) {
        const prev = i === 0 ? 0 : cats[i-1].max;
        const range = cats[i].max - prev;
        const inRange = bf - prev;
        position = (i * 20) + (inRange / range) * 20;
        return { ...cats[i], position: Math.min(position, 98) };
      }
    }
    return { ...cats[cats.length - 1], position: 98 };
  }

  form?.addEventListener('submit', (e) => {
    e.preventDefault();
    const gender = genderSelect.value;
    const height = parseFloat(heightInput.value);
    const weight = parseFloat(weightInput.value);
    const waist = parseFloat(waistInput.value);
    const neck = parseFloat(neckInput.value);
    const hip = parseFloat(hipInput.value);

    if (!height || !weight || !waist || !neck) {
      alert('Please fill in all required fields');
      return;
    }

    if (gender === 'female' && !hip) {
      alert('Hip measurement is required for women');
      return;
    }

    const bf = calculateBodyFat(gender, height, waist, neck, hip);
    const category = getCategory(gender, bf);
    const fatKg = weight * bf / 100;
    const leanKg = weight - fatKg;

    resultArea?.classList.remove('hidden');
    if (bodyfatValue) bodyfatValue.textContent = bf.toFixed(1) + '%';
    if (gaugeIndicator) gaugeIndicator.style.left = category.position + '%';
    if (categoryName) categoryName.textContent = category.name;
    if (categoryDescription) categoryDescription.textContent = category.desc;
    if (fatMass) fatMass.textContent = fatKg.toFixed(1) + ' kg';
    if (leanMass) leanMass.textContent = leanKg.toFixed(1) + ' kg';

    resultArea?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  });

  form?.addEventListener('reset', () => {
    resultArea?.classList.add('hidden');
  });
</script>
