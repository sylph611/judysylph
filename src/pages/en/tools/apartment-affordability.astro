---
import Layout from '../../../layouts/Layout.astro';
import AdBanner from '../../../components/AdBanner.astro';
import ToolSeoContent from '../../../components/ToolSeoContent.astro';
import { getTool, generateToolBreadcrumbSchema, generateToolHowToSchema, calculatorSteps, getToolStepType } from '../../../utils/tools';

const lang = 'en';
const tool = getTool('apartment-affordability', lang);
const siteUrl = 'https://judysylph.com';
const stepType = getToolStepType('apartment-affordability');
const steps = calculatorSteps[lang][stepType];

const webAppSchema = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": tool?.title,
  "description": tool?.description,
  "applicationCategory": "FinanceApplication",
  "operatingSystem": "All",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" }
};

const breadcrumbSchema = tool ? generateToolBreadcrumbSchema(tool, lang, siteUrl) : null;
const howToSchema = tool ? generateToolHowToSchema(tool, lang, siteUrl, steps) : null;
const jsonLd = [webAppSchema, breadcrumbSchema, howToSchema].filter(Boolean);
---

<Layout title={`${tool?.title} | JudySylph`} description={tool?.description} jsonLd={jsonLd}>
  <div class="max-w-4xl mx-auto px-4 py-8">
    <div class="text-center mb-8">
      <div class="text-5xl mb-4">{tool?.emoji}</div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{tool?.title}</h1>
      <p class="text-gray-600 dark:text-gray-400">{tool?.description}</p>
      <p class="text-sm text-primary-600 dark:text-primary-400 mt-2">Based on 2026 US Market Prices</p>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
      <form id="calc-form" class="space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Annual Salary</label>
            <input type="text" id="salary" placeholder="85,000" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Down Payment Saved</label>
            <input type="text" id="assets" placeholder="50,000" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Debt-to-Income Comfort</label>
          <select id="loanWilling" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            <option value="28">Conservative (28% DTI)</option>
            <option value="36" selected>Standard (36% DTI)</option>
            <option value="43">Aggressive (43% DTI)</option>
          </select>
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">Calculate My Home Budget</button>
      </form>

      <div id="result-area" class="mt-8 hidden">
        <div id="result-header" class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-6 text-white text-center mb-6">
          <div class="text-lg opacity-90 mb-2">You Can Afford a Home Up To</div>
          <div id="apt-price" class="text-4xl font-bold mb-2">-</div>
          <div id="apt-size" class="text-xl opacity-90">-</div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center">
            <div class="text-sm text-gray-600 dark:text-gray-400">Est. Mortgage</div>
            <div id="r-loan" class="text-xl font-bold text-primary-600 dark:text-primary-400">-</div>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center">
            <div class="text-sm text-gray-600 dark:text-gray-400">Monthly Payment</div>
            <div id="r-monthly" class="text-xl font-bold text-red-500">-</div>
          </div>
        </div>

        <div id="region-analysis" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl p-5 mb-6">
          <h3 class="font-bold text-gray-900 dark:text-white mb-4">What You Can Buy</h3>
          <div id="regions" class="space-y-3"></div>
        </div>

        <div id="advice-box" class="rounded-xl p-5 mb-6">
          <h3 class="font-bold mb-2">üí° Personalized Advice</h3>
          <p id="advice-text" class="text-sm"></p>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-5">
          <h3 class="font-bold text-gray-900 dark:text-white mb-3">üìä Financial Summary</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Total Budget</span><span id="r-total" class="font-medium">-</span></div>
            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Down Payment</span><span id="r-equity" class="font-medium">-</span></div>
            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Loan-to-Value (LTV)</span><span id="r-ltv" class="font-medium">-</span></div>
          </div>
        </div>

        <!-- SEO Interpretation Content -->
        <div id="seo-content" class="mt-8 space-y-6">
          <h2 id="seo-summary" class="text-2xl font-bold text-gray-900 dark:text-white"></h2>

          <div class="prose dark:prose-invert max-w-none">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">üìå What This Result Means</h3>
            <p id="seo-meaning" class="text-gray-700 dark:text-gray-300 leading-relaxed"></p>
          </div>

          <!-- AD_SLOT: middle-content -->

          <div class="prose dark:prose-invert max-w-none">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">üë§ Who This Is For</h3>
            <p id="seo-suitable" class="text-gray-700 dark:text-gray-300 leading-relaxed"></p>
          </div>

          <div class="prose dark:prose-invert max-w-none">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">‚ö†Ô∏è Important Considerations</h3>
            <p id="seo-caution" class="text-gray-700 dark:text-gray-300 leading-relaxed"></p>
          </div>

          <!-- AD_SLOT: before-faq -->

          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-5">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">‚ùì Frequently Asked Questions</h3>
            <div id="faq-content" class="space-y-4"></div>
          </div>

          <div class="bg-primary-50 dark:bg-primary-900/20 rounded-xl p-5">
            <h3 class="text-lg font-semibold text-primary-800 dark:text-primary-200 mb-3">üîó Related Calculators</h3>
            <div class="flex flex-wrap gap-2">
              <a href="/en/tools/car-affordability" class="px-4 py-2 bg-white dark:bg-gray-800 rounded-lg text-primary-600 dark:text-primary-400 hover:bg-primary-100 dark:hover:bg-gray-700 transition-colors">üöó Car Affordability Calculator</a>
              <a href="/en/tools/salary-percentile" class="px-4 py-2 bg-white dark:bg-gray-800 rounded-lg text-primary-600 dark:text-primary-400 hover:bg-primary-100 dark:hover:bg-gray-700 transition-colors">üìä Salary Percentile Calculator</a>
              <a href="/en/tools/mortgage-calculator" class="px-4 py-2 bg-white dark:bg-gray-800 rounded-lg text-primary-600 dark:text-primary-400 hover:bg-primary-100 dark:hover:bg-gray-700 transition-colors">üè¶ Mortgage Calculator</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-6 bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4">
      <h4 class="font-bold text-blue-800 dark:text-blue-200 mb-2">2026 US Housing Prices (Median)</h4>
      <div class="grid grid-cols-2 gap-2 text-sm text-blue-700 dark:text-blue-300">
        <p>‚Ä¢ San Francisco: $1.2M+</p>
        <p>‚Ä¢ New York City: $700K+</p>
        <p>‚Ä¢ Austin/Denver: $500K+</p>
        <p>‚Ä¢ Midwest: $250-350K</p>
      </div>
    </div>
    <AdBanner className="mt-8" />

    <!-- SEO Content -->
    <ToolSeoContent
      title={tool?.title || ''}
      description={tool?.description || ''}
      emoji={tool?.emoji || ''}
      category={tool?.category || ''}
      lang={lang}
      slug={tool?.slug || ''}
    />

    <div class="mt-8 text-center"><a href="/en/tools" class="text-primary-600 dark:text-primary-400 hover:underline">&larr; Back to Tools</a></div>
  </div>
</Layout>

<script>
  const form = document.getElementById('calc-form') as HTMLFormElement;
  const salaryInput = document.getElementById('salary') as HTMLInputElement;
  const assetsInput = document.getElementById('assets') as HTMLInputElement;

  [salaryInput, assetsInput].forEach(input => {
    input?.addEventListener('input', e => {
      const v = (e.target as HTMLInputElement).value.replace(/\D/g,'');
      (e.target as HTMLInputElement).value = Number(v).toLocaleString();
    });
  });

  const markets = [
    { name: 'San Francisco Bay Area', pricePerSqft: 1200, emoji: 'üåâ' },
    { name: 'New York Metro', pricePerSqft: 800, emoji: 'üóΩ' },
    { name: 'Los Angeles', pricePerSqft: 650, emoji: 'üå¥' },
    { name: 'Seattle/Denver', pricePerSqft: 450, emoji: '‚õ∞Ô∏è' },
    { name: 'Austin/Nashville', pricePerSqft: 350, emoji: 'üé∏' },
    { name: 'Phoenix/Atlanta', pricePerSqft: 280, emoji: '‚òÄÔ∏è' },
    { name: 'Midwest Cities', pricePerSqft: 180, emoji: 'üåæ' },
    { name: 'Rural Areas', pricePerSqft: 120, emoji: 'üè°' }
  ];

  form?.addEventListener('submit', e => {
    e.preventDefault();
    const salary = parseInt(salaryInput.value.replace(/,/g,'')) || 0;
    const downPayment = parseInt(assetsInput.value.replace(/,/g,'')) || 0;
    const dtiRate = parseInt((document.getElementById('loanWilling') as HTMLSelectElement).value) / 100;

    // Monthly payment limit based on DTI
    const monthlyIncome = salary / 12;
    const maxMonthlyPayment = monthlyIncome * dtiRate;

    // Calculate max loan (30yr, 6.5% rate)
    const rate = 0.065 / 12;
    const months = 360;
    const maxLoan = Math.round(maxMonthlyPayment * (Math.pow(1+rate,months)-1) / (rate * Math.pow(1+rate,months)));

    const totalBudget = downPayment + maxLoan;

    // Determine home size category
    let sizeDesc, headerColor;
    if (totalBudget < 200000) {
      sizeDesc = 'Starter Home / Condo';
      headerColor = 'from-gray-500 to-slate-600';
    } else if (totalBudget < 400000) {
      sizeDesc = 'Single Family Starter';
      headerColor = 'from-blue-500 to-cyan-600';
    } else if (totalBudget < 600000) {
      sizeDesc = 'Mid-Range Family Home';
      headerColor = 'from-emerald-500 to-teal-600';
    } else if (totalBudget < 1000000) {
      sizeDesc = 'Upscale Family Home';
      headerColor = 'from-purple-500 to-pink-600';
    } else {
      sizeDesc = 'Luxury Property';
      headerColor = 'from-amber-500 to-orange-600';
    }

    document.getElementById('result-area')?.classList.remove('hidden');

    const header = document.getElementById('result-header')!;
    header.className = `bg-gradient-to-br ${headerColor} rounded-2xl p-6 text-white text-center mb-6`;

    document.getElementById('apt-price')!.textContent = '$' + totalBudget.toLocaleString();
    document.getElementById('apt-size')!.textContent = sizeDesc;

    document.getElementById('r-loan')!.textContent = '$' + maxLoan.toLocaleString();
    document.getElementById('r-monthly')!.textContent = '$' + Math.round(maxMonthlyPayment).toLocaleString() + '/mo';

    // Market analysis
    const regionsDiv = document.getElementById('regions')!;
    regionsDiv.innerHTML = markets.map(m => {
      const sqft = Math.round(totalBudget / m.pricePerSqft);
      const status = sqft >= 2000 ? 'text-green-600' : sqft >= 1200 ? 'text-yellow-600' : 'text-red-500';
      return `
        <div class="flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-600 rounded-lg">
          <span class="text-gray-700 dark:text-gray-300">${m.emoji} ${m.name}</span>
          <span class="${status} font-medium">${sqft.toLocaleString()} sq ft</span>
        </div>
      `;
    }).join('');

    document.getElementById('r-total')!.textContent = '$' + totalBudget.toLocaleString();
    document.getElementById('r-equity')!.textContent = '$' + downPayment.toLocaleString();
    const ltv = Math.round((maxLoan / totalBudget) * 100);
    document.getElementById('r-ltv')!.textContent = ltv + '%';

    // Advice
    let advice, adviceBg;
    if (totalBudget < 250000) {
      advice = 'Consider FHA loans with lower down payment requirements. Look into first-time homebuyer programs in your state for additional assistance.';
      adviceBg = 'bg-yellow-50 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-200';
    } else if (totalBudget < 500000) {
      advice = 'You have solid buying power in many US markets. Focus on neighborhoods with good schools and growth potential. Consider 15-year mortgages if you can afford higher payments.';
      adviceBg = 'bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200';
    } else if (totalBudget < 800000) {
      advice = 'You can afford homes in most US markets except the most expensive coastal cities. Consider properties with rental potential for additional income.';
      adviceBg = 'bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-200';
    } else {
      advice = 'Excellent budget! You have access to premium properties nationwide. Consider working with a luxury real estate specialist to find the best opportunities.';
      adviceBg = 'bg-purple-50 dark:bg-purple-900/20 text-purple-800 dark:text-purple-200';
    }

    const adviceBox = document.getElementById('advice-box')!;
    adviceBox.className = `rounded-xl p-5 mb-6 ${adviceBg}`;
    document.getElementById('advice-text')!.textContent = advice;

    // Generate SEO content
    generateSeoContent(salary, downPayment, totalBudget, maxLoan, ltv, sizeDesc);
  });

  function generateSeoContent(salary: number, downPayment: number, totalBudget: number, maxLoan: number, ltv: number, sizeDesc: string) {
    // Result summary
    let summaryText, statusEmoji;
    if (totalBudget >= 1000000) {
      summaryText = `With a $${salary.toLocaleString()} salary and $${downPayment.toLocaleString()} down payment, you can afford luxury properties in most US markets`;
      statusEmoji = 'üèÜ';
    } else if (totalBudget >= 600000) {
      summaryText = `A $${totalBudget.toLocaleString()} budget opens doors to upscale homes in major metro areas`;
      statusEmoji = '‚úÖ';
    } else if (totalBudget >= 400000) {
      summaryText = `Your $${totalBudget.toLocaleString()} budget provides solid options in most US markets`;
      statusEmoji = 'üìä';
    } else {
      summaryText = `A $${totalBudget.toLocaleString()} budget requires strategic market selection`;
      statusEmoji = 'üí°';
    }
    document.getElementById('seo-summary')!.textContent = `${statusEmoji} Summary: ${summaryText}`;

    // Meaning explanation
    const meaningText = `Based on your $${salary.toLocaleString()} annual salary and $${downPayment.toLocaleString()} down payment, ` +
      `your maximum home budget is approximately $${totalBudget.toLocaleString()}. ` +
      `This includes a mortgage of up to $${maxLoan.toLocaleString()} (${ltv}% LTV). ` +
      `At current 6.5% mortgage rates over 30 years, you can afford ${sizeDesc}. ` +
      `In high-cost markets like San Francisco ($1,200/sqft), this buys ${Math.round(totalBudget/1200).toLocaleString()} sq ft. ` +
      `In affordable markets like the Midwest ($180/sqft), the same budget gets ${Math.round(totalBudget/180).toLocaleString()} sq ft. ` +
      `Your DTI ratio determines monthly payment capacity, which directly impacts how much home you can finance.`;
    document.getElementById('seo-meaning')!.textContent = meaningText;

    // Suitable for
    let suitableText;
    if (totalBudget >= 800000) {
      suitableText = `This budget tier suits high-income professionals seeking premium locations, ` +
        `families prioritizing top school districts, buyers who value long-term appreciation in prime markets, ` +
        `those relocating to high-cost areas for career opportunities, ` +
        `and investors looking at properties with rental income potential in desirable neighborhoods.`;
    } else if (totalBudget >= 400000) {
      suitableText = `This range is ideal for first-time homebuyers in suburban areas, ` +
        `young families transitioning from renting to owning, dual-income households building equity, ` +
        `remote workers who can live in lower-cost markets, ` +
        `and buyers seeking the balance between location, space, and monthly payment affordability.`;
    } else {
      suitableText = `This budget is well-suited for first-time buyers entering the market, ` +
        `singles or couples prioritizing homeownership over location, those willing to consider up-and-coming neighborhoods, ` +
        `buyers in affordable Midwest or Southern markets, ` +
        `and anyone focused on building equity while keeping monthly costs manageable.`;
    }
    document.getElementById('seo-suitable')!.textContent = suitableText;

    // Cautions
    let cautionText = `When purchasing a home, several factors require careful consideration. First, closing costs typically add 2-5% ` +
      `($${Math.round(totalBudget * 0.03).toLocaleString()}-$${Math.round(totalBudget * 0.05).toLocaleString()}) including title insurance, ` +
      `appraisal, inspection, and lender fees. Second, `;
    if (ltv > 80) {
      cautionText += `with an LTV of ${ltv}%, you'll likely need Private Mortgage Insurance (PMI) adding $100-300/month until you reach 20% equity. ` +
        `Consider a larger down payment if possible to avoid PMI and secure better rates. `;
    }
    cautionText += `Third, factor in ongoing costs: property taxes (1-2% of value annually), homeowners insurance ($1,000-3,000/year), ` +
      `HOA fees if applicable ($200-500/month), and maintenance (budget 1% of home value yearly). ` +
      `Finally, interest rates significantly impact affordability‚Äîa 1% rate increase reduces buying power by approximately 10%.`;
    document.getElementById('seo-caution')!.textContent = cautionText;

    // FAQ
    const faqs = [
      {
        q: 'Is this the same as a mortgage pre-approval?',
        a: 'No, this calculator provides an estimate based on general DTI guidelines. A mortgage pre-approval from a lender involves credit checks, income verification, and is based on your specific financial situation. Always get pre-approved before house hunting.'
      },
      {
        q: 'What\'s the difference between DTI 28% and 43%?',
        a: `Conservative DTI (28%) means lower monthly payments with more budget flexibility for other expenses. Standard (36%) is the traditional "front-end" ratio most lenders prefer. Aggressive (43%) maximizes buying power but leaves less room for other financial goals. Your choice of $${Math.round(maxLoan).toLocaleString()} mortgage is based on your selected DTI.`
      },
      {
        q: 'Why do home prices vary so much by location?',
        a: 'Housing costs reflect local demand, job markets, amenities, and land availability. Coastal metros like SF and NYC have limited supply and high demand from tech/finance jobs. Midwest and rural areas offer more affordable options due to lower demand and more available land.'
      },
      {
        q: 'Should I buy now or wait for lower rates?',
        a: `With rates around 6.5% and a budget of $${totalBudget.toLocaleString()}, consider that timing the market is difficult. If you plan to stay 5+ years, buying now builds equity. You can refinance if rates drop. However, if rates rise, your buying power decreases. Focus on what you can comfortably afford monthly rather than timing.`
      }
    ];

    const faqContainer = document.getElementById('faq-content')!;
    faqContainer.innerHTML = faqs.map(faq => `
      <details class="group">
        <summary class="flex justify-between items-center cursor-pointer list-none p-3 bg-white dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600">
          <span class="font-medium text-gray-900 dark:text-white">${faq.q}</span>
          <span class="text-gray-500 group-open:rotate-180 transition-transform">‚ñº</span>
        </summary>
        <p class="mt-2 px-3 text-gray-600 dark:text-gray-400 text-sm">${faq.a}</p>
      </details>
    `).join('');

    // JSON-LD FAQ Schema
    const faqSchema = {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": faqs.map(faq => ({
        "@type": "Question",
        "name": faq.q,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": faq.a
        }
      }))
    };

    let schemaScript = document.getElementById('faq-schema');
    if (!schemaScript) {
      schemaScript = document.createElement('script');
      schemaScript.id = 'faq-schema';
      schemaScript.type = 'application/ld+json';
      document.head.appendChild(schemaScript);
    }
    schemaScript.textContent = JSON.stringify(faqSchema);
  }
</script>
