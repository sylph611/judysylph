---
import Layout from '../../../layouts/Layout.astro';
import { getTool } from '../../../utils/tools';

const lang = 'en';
const tool = getTool('apartment-affordability', lang);
---

<Layout title={`${tool?.title} | JudySylph`} description={tool?.description}>
  <div class="max-w-4xl mx-auto px-4 py-8">
    <div class="text-center mb-8">
      <div class="text-5xl mb-4">{tool?.emoji}</div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{tool?.title}</h1>
      <p class="text-gray-600 dark:text-gray-400">{tool?.description}</p>
      <p class="text-sm text-primary-600 dark:text-primary-400 mt-2">Based on 2026 US Market Prices</p>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
      <form id="calc-form" class="space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Annual Salary</label>
            <input type="text" id="salary" placeholder="85,000" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Down Payment Saved</label>
            <input type="text" id="assets" placeholder="50,000" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Debt-to-Income Comfort</label>
          <select id="loanWilling" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            <option value="28">Conservative (28% DTI)</option>
            <option value="36" selected>Standard (36% DTI)</option>
            <option value="43">Aggressive (43% DTI)</option>
          </select>
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">Calculate My Home Budget</button>
      </form>

      <div id="result-area" class="mt-8 hidden">
        <div id="result-header" class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-6 text-white text-center mb-6">
          <div class="text-lg opacity-90 mb-2">You Can Afford a Home Up To</div>
          <div id="apt-price" class="text-4xl font-bold mb-2">-</div>
          <div id="apt-size" class="text-xl opacity-90">-</div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center">
            <div class="text-sm text-gray-600 dark:text-gray-400">Est. Mortgage</div>
            <div id="r-loan" class="text-xl font-bold text-primary-600 dark:text-primary-400">-</div>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center">
            <div class="text-sm text-gray-600 dark:text-gray-400">Monthly Payment</div>
            <div id="r-monthly" class="text-xl font-bold text-red-500">-</div>
          </div>
        </div>

        <div id="region-analysis" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl p-5 mb-6">
          <h3 class="font-bold text-gray-900 dark:text-white mb-4">What You Can Buy</h3>
          <div id="regions" class="space-y-3"></div>
        </div>

        <div id="advice-box" class="rounded-xl p-5 mb-6">
          <h3 class="font-bold mb-2">ðŸ’¡ Personalized Advice</h3>
          <p id="advice-text" class="text-sm"></p>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-5">
          <h3 class="font-bold text-gray-900 dark:text-white mb-3">ðŸ“Š Financial Summary</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Total Budget</span><span id="r-total" class="font-medium">-</span></div>
            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Down Payment</span><span id="r-equity" class="font-medium">-</span></div>
            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Loan-to-Value (LTV)</span><span id="r-ltv" class="font-medium">-</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-6 bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4">
      <h4 class="font-bold text-blue-800 dark:text-blue-200 mb-2">2026 US Housing Prices (Median)</h4>
      <div class="grid grid-cols-2 gap-2 text-sm text-blue-700 dark:text-blue-300">
        <p>â€¢ San Francisco: $1.2M+</p>
        <p>â€¢ New York City: $700K+</p>
        <p>â€¢ Austin/Denver: $500K+</p>
        <p>â€¢ Midwest: $250-350K</p>
      </div>
    </div>
    <div class="mt-8 text-center"><a href="/en/tools" class="text-primary-600 dark:text-primary-400 hover:underline">&larr; Back to Tools</a></div>
  </div>
</Layout>

<script>
  const form = document.getElementById('calc-form') as HTMLFormElement;
  const salaryInput = document.getElementById('salary') as HTMLInputElement;
  const assetsInput = document.getElementById('assets') as HTMLInputElement;

  [salaryInput, assetsInput].forEach(input => {
    input?.addEventListener('input', e => {
      const v = (e.target as HTMLInputElement).value.replace(/\D/g,'');
      (e.target as HTMLInputElement).value = Number(v).toLocaleString();
    });
  });

  const markets = [
    { name: 'San Francisco Bay Area', pricePerSqft: 1200, emoji: 'ðŸŒ‰' },
    { name: 'New York Metro', pricePerSqft: 800, emoji: 'ðŸ—½' },
    { name: 'Los Angeles', pricePerSqft: 650, emoji: 'ðŸŒ´' },
    { name: 'Seattle/Denver', pricePerSqft: 450, emoji: 'â›°ï¸' },
    { name: 'Austin/Nashville', pricePerSqft: 350, emoji: 'ðŸŽ¸' },
    { name: 'Phoenix/Atlanta', pricePerSqft: 280, emoji: 'â˜€ï¸' },
    { name: 'Midwest Cities', pricePerSqft: 180, emoji: 'ðŸŒ¾' },
    { name: 'Rural Areas', pricePerSqft: 120, emoji: 'ðŸ¡' }
  ];

  form?.addEventListener('submit', e => {
    e.preventDefault();
    const salary = parseInt(salaryInput.value.replace(/,/g,'')) || 0;
    const downPayment = parseInt(assetsInput.value.replace(/,/g,'')) || 0;
    const dtiRate = parseInt((document.getElementById('loanWilling') as HTMLSelectElement).value) / 100;

    // Monthly payment limit based on DTI
    const monthlyIncome = salary / 12;
    const maxMonthlyPayment = monthlyIncome * dtiRate;

    // Calculate max loan (30yr, 6.5% rate)
    const rate = 0.065 / 12;
    const months = 360;
    const maxLoan = Math.round(maxMonthlyPayment * (Math.pow(1+rate,months)-1) / (rate * Math.pow(1+rate,months)));

    const totalBudget = downPayment + maxLoan;

    // Determine home size category
    let sizeDesc, headerColor;
    if (totalBudget < 200000) {
      sizeDesc = 'Starter Home / Condo';
      headerColor = 'from-gray-500 to-slate-600';
    } else if (totalBudget < 400000) {
      sizeDesc = 'Single Family Starter';
      headerColor = 'from-blue-500 to-cyan-600';
    } else if (totalBudget < 600000) {
      sizeDesc = 'Mid-Range Family Home';
      headerColor = 'from-emerald-500 to-teal-600';
    } else if (totalBudget < 1000000) {
      sizeDesc = 'Upscale Family Home';
      headerColor = 'from-purple-500 to-pink-600';
    } else {
      sizeDesc = 'Luxury Property';
      headerColor = 'from-amber-500 to-orange-600';
    }

    document.getElementById('result-area')?.classList.remove('hidden');

    const header = document.getElementById('result-header')!;
    header.className = `bg-gradient-to-br ${headerColor} rounded-2xl p-6 text-white text-center mb-6`;

    document.getElementById('apt-price')!.textContent = '$' + totalBudget.toLocaleString();
    document.getElementById('apt-size')!.textContent = sizeDesc;

    document.getElementById('r-loan')!.textContent = '$' + maxLoan.toLocaleString();
    document.getElementById('r-monthly')!.textContent = '$' + Math.round(maxMonthlyPayment).toLocaleString() + '/mo';

    // Market analysis
    const regionsDiv = document.getElementById('regions')!;
    regionsDiv.innerHTML = markets.map(m => {
      const sqft = Math.round(totalBudget / m.pricePerSqft);
      const status = sqft >= 2000 ? 'text-green-600' : sqft >= 1200 ? 'text-yellow-600' : 'text-red-500';
      return `
        <div class="flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-600 rounded-lg">
          <span class="text-gray-700 dark:text-gray-300">${m.emoji} ${m.name}</span>
          <span class="${status} font-medium">${sqft.toLocaleString()} sq ft</span>
        </div>
      `;
    }).join('');

    document.getElementById('r-total')!.textContent = '$' + totalBudget.toLocaleString();
    document.getElementById('r-equity')!.textContent = '$' + downPayment.toLocaleString();
    const ltv = Math.round((maxLoan / totalBudget) * 100);
    document.getElementById('r-ltv')!.textContent = ltv + '%';

    // Advice
    let advice, adviceBg;
    if (totalBudget < 250000) {
      advice = 'Consider FHA loans with lower down payment requirements. Look into first-time homebuyer programs in your state for additional assistance.';
      adviceBg = 'bg-yellow-50 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-200';
    } else if (totalBudget < 500000) {
      advice = 'You have solid buying power in many US markets. Focus on neighborhoods with good schools and growth potential. Consider 15-year mortgages if you can afford higher payments.';
      adviceBg = 'bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200';
    } else if (totalBudget < 800000) {
      advice = 'You can afford homes in most US markets except the most expensive coastal cities. Consider properties with rental potential for additional income.';
      adviceBg = 'bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-200';
    } else {
      advice = 'Excellent budget! You have access to premium properties nationwide. Consider working with a luxury real estate specialist to find the best opportunities.';
      adviceBg = 'bg-purple-50 dark:bg-purple-900/20 text-purple-800 dark:text-purple-200';
    }

    const adviceBox = document.getElementById('advice-box')!;
    adviceBox.className = `rounded-xl p-5 mb-6 ${adviceBg}`;
    document.getElementById('advice-text')!.textContent = advice;
  });
</script>
