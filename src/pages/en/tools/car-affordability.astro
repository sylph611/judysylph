---
import Layout from '../../../layouts/Layout.astro';
import AdBanner from '../../../components/AdBanner.astro';
import ToolSeoContent from '../../../components/ToolSeoContent.astro';
import { getTool, generateToolBreadcrumbSchema, generateToolHowToSchema, calculatorSteps, getToolStepType } from '../../../utils/tools';

const lang = 'en';
const tool = getTool('car-affordability', lang);
const siteUrl = 'https://judysylph.com';
const stepType = getToolStepType('car-affordability');
const steps = calculatorSteps[lang][stepType];

const webAppSchema = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": tool?.title,
  "description": tool?.description,
  "applicationCategory": "FinanceApplication",
  "operatingSystem": "All",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" }
};

const breadcrumbSchema = tool ? generateToolBreadcrumbSchema(tool, lang, siteUrl) : null;
const howToSchema = tool ? generateToolHowToSchema(tool, lang, siteUrl, steps) : null;
const jsonLd = [webAppSchema, breadcrumbSchema, howToSchema].filter(Boolean);
---

<Layout title={`${tool?.title} | JudySylph`} description={tool?.description} jsonLd={jsonLd}>
  <div class="max-w-4xl mx-auto px-4 py-8">
    <div class="text-center mb-8">
      <div class="text-5xl mb-4">{tool?.emoji}</div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{tool?.title}</h1>
      <p class="text-gray-600 dark:text-gray-400">{tool?.description}</p>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
      <form id="calc-form" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Annual Salary (before tax)</label>
          <input type="text" id="salary" placeholder="75,000" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current Savings</label>
          <input type="text" id="savings" placeholder="20,000" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Monthly Savings</label>
          <input type="text" id="monthlySave" placeholder="1,000" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">Find My Car</button>
      </form>

      <div id="result-area" class="mt-8 hidden">
        <div class="bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl p-6 text-white text-center mb-6">
          <div class="text-lg opacity-90 mb-2">You Can Afford</div>
          <div id="car-grade" class="text-4xl font-bold mb-2">-</div>
          <div id="car-price-range" class="text-xl opacity-90">-</div>
        </div>

        <div id="car-recommendation" class="bg-gray-50 dark:bg-gray-700 rounded-xl p-5 mb-6">
          <h3 class="font-bold text-gray-900 dark:text-white mb-3">Recommended Vehicles</h3>
          <div id="car-models" class="space-y-2"></div>
        </div>

        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl p-5 mb-6">
          <h3 class="font-bold text-gray-900 dark:text-white mb-3">Financial Analysis</h3>
          <div class="space-y-3">
            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Recommended Budget</span><span id="r-proper" class="font-medium">-</span></div>
            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Maximum Budget</span><span id="r-max" class="font-medium">-</span></div>
            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Est. Monthly Cost</span><span id="r-monthly" class="font-medium">-</span></div>
          </div>
        </div>

        <div id="advice-box" class="rounded-xl p-5">
          <h3 class="font-bold mb-2">üí° Advice</h3>
          <p id="advice-text" class="text-sm"></p>
        </div>

        <!-- SEO Interpretation Content -->
        <div id="seo-content" class="mt-8 space-y-6">
          <h2 id="seo-summary" class="text-2xl font-bold text-gray-900 dark:text-white"></h2>

          <div class="prose dark:prose-invert max-w-none">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">üìå What This Result Means</h3>
            <p id="seo-meaning" class="text-gray-700 dark:text-gray-300 leading-relaxed"></p>
          </div>

          <!-- AD_SLOT: middle-content -->

          <div class="prose dark:prose-invert max-w-none">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">üë§ Who This Is For</h3>
            <p id="seo-suitable" class="text-gray-700 dark:text-gray-300 leading-relaxed"></p>
          </div>

          <div class="prose dark:prose-invert max-w-none">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">‚ö†Ô∏è Important Considerations</h3>
            <p id="seo-caution" class="text-gray-700 dark:text-gray-300 leading-relaxed"></p>
          </div>

          <!-- AD_SLOT: before-faq -->

          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-5">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">‚ùì Frequently Asked Questions</h3>
            <div id="faq-content" class="space-y-4"></div>
          </div>

          <div class="bg-primary-50 dark:bg-primary-900/20 rounded-xl p-5">
            <h3 class="text-lg font-semibold text-primary-800 dark:text-primary-200 mb-3">üîó Related Calculators</h3>
            <div class="flex flex-wrap gap-2">
              <a href="/en/tools/apartment-affordability" class="px-4 py-2 bg-white dark:bg-gray-800 rounded-lg text-primary-600 dark:text-primary-400 hover:bg-primary-100 dark:hover:bg-gray-700 transition-colors">üè¢ Home Affordability Calculator</a>
              <a href="/en/tools/salary-percentile" class="px-4 py-2 bg-white dark:bg-gray-800 rounded-lg text-primary-600 dark:text-primary-400 hover:bg-primary-100 dark:hover:bg-gray-700 transition-colors">üìä Salary Percentile Calculator</a>
              <a href="/en/tools/salary-calculator" class="px-4 py-2 bg-white dark:bg-gray-800 rounded-lg text-primary-600 dark:text-primary-400 hover:bg-primary-100 dark:hover:bg-gray-700 transition-colors">üí∞ Salary Calculator</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-6 bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4">
      <h4 class="font-bold text-blue-800 dark:text-blue-200 mb-2">Car Buying Guidelines</h4>
      <ul class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
        <li>‚Ä¢ <strong>Recommended</strong>: 30-50% of annual salary</li>
        <li>‚Ä¢ <strong>Maximum</strong>: Don't exceed 100% of annual salary</li>
        <li>‚Ä¢ <strong>Monthly costs</strong>: Insurance, gas, maintenance ~$300-600/month</li>
      </ul>
    </div>
    <AdBanner className="mt-8" />

    <!-- SEO Content -->
    <ToolSeoContent
      title={tool?.title || ''}
      description={tool?.description || ''}
      emoji={tool?.emoji || ''}
      category={tool?.category || ''}
      lang={lang}
      slug={tool?.slug || ''}
    />

    <div class="mt-8 text-center"><a href="/en/tools" class="text-primary-600 dark:text-primary-400 hover:underline">&larr; Back to Tools</a></div>
  </div>
</Layout>

<script>
  const form = document.getElementById('calc-form') as HTMLFormElement;
  const inputs = ['salary', 'savings', 'monthlySave'].map(id => document.getElementById(id) as HTMLInputElement);

  inputs.forEach(input => {
    input?.addEventListener('input', e => {
      const v = (e.target as HTMLInputElement).value.replace(/\D/g,'');
      (e.target as HTMLInputElement).value = Number(v).toLocaleString();
    });
  });

  const carData = [
    { grade: 'üöô Economy', min: 0, max: 20000, models: ['Honda Fit', 'Toyota Corolla', 'Hyundai Elantra', 'Kia Rio'], color: 'from-green-500 to-teal-500' },
    { grade: 'üöó Compact', min: 20000, max: 30000, models: ['Honda Civic', 'Toyota Camry', 'Mazda3', 'VW Jetta'], color: 'from-blue-500 to-cyan-500' },
    { grade: 'üöò Midsize', min: 30000, max: 45000, models: ['Honda Accord', 'Toyota RAV4', 'Mazda CX-5', 'Subaru Outback'], color: 'from-indigo-500 to-purple-500' },
    { grade: 'üöê Crossover/SUV', min: 45000, max: 60000, models: ['Toyota Highlander', 'Honda Pilot', 'Jeep Grand Cherokee', 'Ford Explorer'], color: 'from-purple-500 to-pink-500' },
    { grade: 'üèéÔ∏è Premium', min: 60000, max: 85000, models: ['BMW 3 Series', 'Mercedes C-Class', 'Audi A4', 'Lexus ES'], color: 'from-pink-500 to-rose-500' },
    { grade: 'üëë Luxury', min: 85000, max: Infinity, models: ['BMW 5/7 Series', 'Mercedes E/S-Class', 'Porsche Cayenne', 'Tesla Model S'], color: 'from-amber-500 to-orange-500' }
  ];

  const advices = {
    low: { bg: 'bg-yellow-50 dark:bg-yellow-900/20', text: 'text-yellow-800 dark:text-yellow-200', msg: 'Based on your income and savings, consider a used car or economy model. Avoid overextending on car payments.' },
    mid: { bg: 'bg-green-50 dark:bg-green-900/20', text: 'text-green-800 dark:text-green-200', msg: 'You can comfortably afford a mid-range vehicle. A 36-48 month loan should fit your budget well.' },
    high: { bg: 'bg-blue-50 dark:bg-blue-900/20', text: 'text-blue-800 dark:text-blue-200', msg: 'You have room in your budget! Consider paying cash or a short-term loan for better deals.' },
    veryHigh: { bg: 'bg-purple-50 dark:bg-purple-900/20', text: 'text-purple-800 dark:text-purple-200', msg: 'Premium and luxury vehicles are well within your reach. Choose what makes you happy!' }
  };

  form?.addEventListener('submit', e => {
    e.preventDefault();
    const salary = parseInt(inputs[0].value.replace(/,/g,'')) || 0;
    const savings = parseInt(inputs[1].value.replace(/,/g,'')) || 0;
    const monthly = parseInt(inputs[2].value.replace(/,/g,'')) || 0;

    const properPrice = Math.min(salary * 0.5, savings * 0.8 + monthly * 12);
    const maxPrice = Math.min(salary, savings + monthly * 24);

    const targetPrice = (properPrice + maxPrice) / 2;
    const car = carData.find(c => targetPrice >= c.min && targetPrice < c.max) || carData[0];

    const gradient = document.querySelector('#result-area > div:first-child') as HTMLElement;
    gradient.className = `bg-gradient-to-br ${car.color} rounded-2xl p-6 text-white text-center mb-6`;

    document.getElementById('result-area')?.classList.remove('hidden');
    document.getElementById('car-grade')!.textContent = car.grade;
    document.getElementById('car-price-range')!.textContent = car.max === Infinity
      ? `$${car.min.toLocaleString()}+`
      : `$${car.min.toLocaleString()} - $${car.max.toLocaleString()}`;

    const modelsDiv = document.getElementById('car-models')!;
    modelsDiv.innerHTML = car.models.map(m => `<div class="flex items-center gap-2 text-gray-700 dark:text-gray-300"><span class="w-2 h-2 bg-primary-500 rounded-full"></span>${m}</div>`).join('');

    document.getElementById('r-proper')!.textContent = '$' + properPrice.toLocaleString();
    document.getElementById('r-max')!.textContent = '$' + maxPrice.toLocaleString();

    const monthlyMaintenance = Math.round(targetPrice * 0.012);
    document.getElementById('r-monthly')!.textContent = `~$${monthlyMaintenance.toLocaleString()}/mo`;

    let advice;
    if (salary < 50000) advice = advices.low;
    else if (salary < 80000) advice = advices.mid;
    else if (salary < 120000) advice = advices.high;
    else advice = advices.veryHigh;

    const adviceBox = document.getElementById('advice-box')!;
    adviceBox.className = `rounded-xl p-5 ${advice.bg}`;
    document.getElementById('advice-text')!.className = `text-sm ${advice.text}`;
    document.getElementById('advice-text')!.textContent = advice.msg;

    // Generate SEO content
    generateSeoContent(salary, properPrice, maxPrice, car, targetPrice);
  });

  function generateSeoContent(salary: number, properPrice: number, maxPrice: number, car: any, targetPrice: number) {
    const ratio = Math.round((targetPrice / salary) * 100);
    const isHighRatio = ratio > 70;
    const isLowRatio = ratio < 30;

    // Result summary
    let summaryText;
    if (salary >= 120000) {
      summaryText = `With a $${salary.toLocaleString()} salary, ${car.grade} vehicles are well within your budget`;
    } else if (salary >= 80000) {
      summaryText = `A $${salary.toLocaleString()} salary comfortably supports ${car.grade} vehicle purchases`;
    } else if (salary >= 50000) {
      summaryText = `Based on your $${salary.toLocaleString()} salary, ${car.grade} vehicles are appropriate`;
    } else {
      summaryText = `With a $${salary.toLocaleString()} salary, we recommend focusing on ${car.grade} vehicles`;
    }
    document.getElementById('seo-summary')!.textContent = `üìã Summary: ${summaryText}`;

    // Meaning explanation
    const meaningText = `This analysis is based on your annual salary of $${salary.toLocaleString()} and current savings. ` +
      `Your recommended budget of $${properPrice.toLocaleString()} represents ${Math.round(properPrice/salary*100)}% of your annual income, ` +
      `which is ${isHighRatio ? 'on the higher end but manageable' : isLowRatio ? 'very conservative and safe' : 'within the typically recommended range'}. ` +
      `For this budget, you can consider vehicles like ${car.models.slice(0, 2).join(' or ')} in the $${car.min.toLocaleString()}-${car.max === Infinity ? 'above' : '$' + car.max.toLocaleString()} range. ` +
      `Monthly ownership costs (insurance, gas, maintenance) are estimated at ~$${Math.round(targetPrice * 0.012).toLocaleString()}, ` +
      `representing about ${Math.round(targetPrice * 0.012 / (salary / 12) * 100)}% of your monthly income.`;
    document.getElementById('seo-meaning')!.textContent = meaningText;

    // Suitable for
    let suitableText;
    if (salary >= 100000) {
      suitableText = `This budget tier is ideal for high-income professionals, executives, or business owners who value premium quality. ` +
        `It suits those who prioritize advanced safety features, luxury amenities, and brand prestige. ` +
        `Also recommended for families needing spacious vehicles for long commutes or frequent road trips, ` +
        `and individuals who see their vehicle as both transportation and a reflection of professional success.`;
    } else if (salary >= 60000) {
      suitableText = `This range is perfect for established professionals in their 30s-40s with stable careers. ` +
        `Ideal for dual-income households seeking reliable family transportation, those who value practicality without sacrificing quality, ` +
        `weekend adventurers who need versatile vehicles, and buyers who prefer new car warranties over used car uncertainties.`;
    } else {
      suitableText = `This budget is well-suited for young professionals starting their careers, recent graduates buying their first car, ` +
        `individuals prioritizing savings and viewing cars purely as transportation, urban dwellers with short commutes, ` +
        `and practical buyers who want to minimize ongoing costs while maintaining reliable transportation.`;
    }
    document.getElementById('seo-suitable')!.textContent = suitableText;

    // Cautions
    let cautionText = `When purchasing a vehicle, several factors deserve careful consideration. First, beyond the sticker price, ` +
      `expect 10-15% in additional costs including sales tax (varies by state), registration, documentation fees, and dealer charges. ` +
      `Second, if financing, compare APR rates carefully as they significantly impact total cost‚Äîeven 1% difference on a $30,000 loan ` +
      `means $1,500+ over 5 years. Third, `;
    if (isHighRatio) {
      cautionText += `your target price is on the higher end relative to income. ` +
        `Consider avoiding loan terms beyond 48 months, opt for base trims over loaded options, ` +
        `and maintain an emergency fund of 3-6 months expenses before committing. ` +
        `A certified pre-owned vehicle could provide significant savings with similar reliability.`;
    } else {
      cautionText += `factor in long-term ownership costs including insurance (varies by vehicle class), fuel economy, ` +
        `and typical maintenance expenses. For your budget, a 2-3 year old certified pre-owned vehicle ` +
        `could offer excellent value with significant depreciation already absorbed, ` +
        `allowing you to get more features for the same money.`;
    }
    document.getElementById('seo-caution')!.textContent = cautionText;

    // FAQ
    const faqs = [
      {
        q: 'Is this calculator result legally binding?',
        a: 'No, this is a financial planning tool based on general guidelines. Actual loan approval amounts depend on your credit score, debt-to-income ratio, employment history, and lender policies. Always consult with banks or credit unions for accurate pre-approval amounts.'
      },
      {
        q: 'What\'s the difference between recommended and maximum budget?',
        a: `The recommended budget ($${properPrice.toLocaleString()}) is 30-50% of annual salary‚Äîa comfortable range that maintains financial flexibility. The maximum ($${maxPrice.toLocaleString()}) is the upper limit where a purchase is still feasible but may strain other financial goals.`
      },
      {
        q: 'Why might actual car prices differ from these ranges?',
        a: 'This calculator uses 2026 US average new car prices. Actual costs vary by trim level, options, dealer markups, regional pricing, and negotiations. Used cars can be 30-60% less depending on age and mileage, offering significant savings.'
      },
      {
        q: 'How is monthly ownership cost calculated?',
        a: 'Monthly costs are estimated at ~1.2% of vehicle value annually, divided by 12. This includes auto insurance ($100-200/mo), fuel ($150-300/mo), and maintenance ($50-100/mo). Actual costs vary based on driving habits, location, and vehicle type.'
      }
    ];

    const faqContainer = document.getElementById('faq-content')!;
    faqContainer.innerHTML = faqs.map(faq => `
      <details class="group">
        <summary class="flex justify-between items-center cursor-pointer list-none p-3 bg-white dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600">
          <span class="font-medium text-gray-900 dark:text-white">${faq.q}</span>
          <span class="text-gray-500 group-open:rotate-180 transition-transform">‚ñº</span>
        </summary>
        <p class="mt-2 px-3 text-gray-600 dark:text-gray-400 text-sm">${faq.a}</p>
      </details>
    `).join('');

    // JSON-LD FAQ Schema
    const faqSchema = {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": faqs.map(faq => ({
        "@type": "Question",
        "name": faq.q,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": faq.a
        }
      }))
    };

    let schemaScript = document.getElementById('faq-schema');
    if (!schemaScript) {
      schemaScript = document.createElement('script');
      schemaScript.id = 'faq-schema';
      schemaScript.type = 'application/ld+json';
      document.head.appendChild(schemaScript);
    }
    schemaScript.textContent = JSON.stringify(faqSchema);
  }
</script>
