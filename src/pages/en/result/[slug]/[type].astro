---
import Layout from '../../../../layouts/Layout.astro';
import Result from '../../../../components/Result.astro';
import ShareButtons from '../../../../components/ShareButtons.astro';
import ResultActions from '../../../../components/ResultActions.astro';
import TestCard from '../../../../components/TestCard.astro';
import Confetti from '../../../../components/Confetti.astro';
import AdBanner from '../../../../components/AdBanner.astro';
import { getTest, getAllTests, getRecommendedTests } from '../../../../utils/tests';

export function getStaticPaths() {
  const tests = getAllTests('en');
  const paths = [];

  tests.forEach((test) => {
    test.results.forEach((result) => {
      paths.push({
        params: { slug: test.slug, type: result.type },
      });
    });
  });

  return paths;
}

const { slug, type } = Astro.params;
const lang = 'en';
const test = getTest(slug, lang);

if (!test) {
  return Astro.redirect('/en');
}

const result = test.results.find(r => r.type === type);

if (!result) {
  return Astro.redirect(`/en/test/${slug}`);
}

const pageTitle = `${result.title} - ${test.title} | JudySylph`;
const pageDescription = `My result: ${result.title}. ${result.description.substring(0, 100)}...`;
const siteUrl = Astro.site?.toString().replace(/\/$/, '') || 'https://judysylph.com';
const pageUrl = `${siteUrl}/en/result/${slug}/${type}`;
const ogImage = `${siteUrl}/og/${slug}/${type}.svg`;

const otherTests = getRecommendedTests(lang, slug, 3);

// JSON-LD structured data
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Quiz",
  "name": test.title,
  "description": test.description,
  "about": {
    "@type": "Thing",
    "name": "Personality Test"
  }
};
---

<Layout title={pageTitle} description={pageDescription} ogImage={ogImage}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </Fragment>

  <!-- Confetti Animation -->
  <Confetti />

  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Result Component -->
    <Result
      type={result.type}
      title={result.title}
      emoji={result.emoji}
      description={result.description}
      traits={result.traits}
      advice={result.advice}
      compatibility={result.compatibility}
      lang={lang}
    />

    <!-- Share Buttons -->
    <ShareButtons
      url={pageUrl}
      title={`My ${test.title} result: ${result.title} ${result.emoji}`}
      description={result.description}
      lang={lang}
    />

    <!-- Image Save & QR Code -->
    <ResultActions
      url={pageUrl}
      resultTitle={result.title}
      resultEmoji={result.emoji}
      testTitle={test.title}
      lang={lang}
    />

    <!-- Compare with Friend -->
    <div class="mt-8 p-4 bg-gradient-to-r from-primary-50 to-secondary-50 dark:from-primary-900/20 dark:to-secondary-900/20 rounded-2xl">
      <div class="text-center">
        <p class="text-gray-700 dark:text-gray-300 mb-3">Compare your results with a friend!</p>
        <button
          id="compare-btn"
          type="button"
          class="px-6 py-3 bg-gradient-to-r from-primary-500 to-secondary-500 text-white rounded-xl font-medium hover:opacity-90 transition-opacity"
          data-slug={slug}
          data-type={type}
        >
          ü§ù Compare with Friend
        </button>
      </div>
    </div>

    <!-- Ad Banner -->
    <AdBanner className="mt-8" />

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
      <a
        href={`/${lang}/test/${slug}`}
        class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors text-center"
      >
        Take Test Again
      </a>
      <a
        href={`/${lang}`}
        class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-xl font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-center"
      >
        View Other Tests
      </a>
    </div>

    <!-- Ad Banner 2 -->
    <AdBanner className="mt-8" />

    <!-- Recommended Tests -->
    {otherTests.length > 0 && (
      <section class="mt-16">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2 text-center">
          People Who Took This Test Also Liked
        </h2>
        <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Recommended tests based on similar interests</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          {otherTests.map((t) => (
            <TestCard
              slug={t.slug}
              title={t.title}
              description={t.description}
              emoji={t.emoji}
              questionCount={t.questionCount}
              lang={lang}
            />
          ))}
        </div>
      </section>
    )}
  </div>
  <!-- Save Result Script -->
  <script define:vars={{ testTitle: test.title, resultTitle: result.title, resultEmoji: result.emoji || test.emoji, slug, type, testEmoji: test.emoji }}>
    // Save result to localStorage
    const saveResult = () => {
      const history = JSON.parse(localStorage.getItem('testHistory') || '[]');

      const newResult = {
        id: Date.now(),
        testSlug: slug,
        testTitle: testTitle,
        testEmoji: testEmoji,
        resultType: type,
        resultTitle: resultTitle,
        resultEmoji: resultEmoji,
        date: new Date().toISOString(),
        lang: 'en'
      };

      // Check if same test was taken recently (within 1 hour)
      const recentIndex = history.findIndex(h =>
        h.testSlug === slug &&
        h.resultType === type &&
        Date.now() - new Date(h.date).getTime() < 3600000
      );

      if (recentIndex === -1) {
        // Add new result at the beginning
        history.unshift(newResult);
        // Keep only last 50 results
        if (history.length > 50) history.pop();
        localStorage.setItem('testHistory', JSON.stringify(history));
      }
    };

    // Save on page load
    saveResult();

    // Compare button handler
    const compareBtn = document.getElementById('compare-btn');
    compareBtn?.addEventListener('click', async () => {
      const myType = compareBtn.getAttribute('data-type');
      const testSlug = compareBtn.getAttribute('data-slug');
      const compareUrl = `${window.location.origin}/en/result/${testSlug}/compare?me=${myType}&friend=`;

      try {
        await navigator.clipboard.writeText(compareUrl);
        alert('Comparison link copied!\n\nSend the test link to your friend and ask for their result.\nThen add their result type after [friend=] in the copied link.');
      } catch (err) {
        // Prompt fallback
        const friendType = prompt('Enter your friend\'s result type (e.g., dog, cat):');
        if (friendType) {
          window.location.href = `/en/result/${testSlug}/compare?me=${myType}&friend=${friendType}`;
        }
      }
    });
  </script>
</Layout>
