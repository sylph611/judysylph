---
import Layout from '../../../layouts/Layout.astro';
import Question from '../../../components/Question.astro';
import TestSeoContent from '../../../components/TestSeoContent.astro';
import { getTest, getAllTests } from '../../../utils/tests';

export function getStaticPaths() {
  const tests = getAllTests('en');
  return tests.map((test) => ({
    params: { slug: test.slug },
  }));
}

const { slug } = Astro.params;
const lang = 'en';
const test = getTest(slug, lang);

if (!test) {
  return Astro.redirect('/en');
}

const pageTitle = `${test.title} | JudySylph`;
const pageDescription = test.description;

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Quiz",
  "name": test.title,
  "description": test.description,
  "educationalLevel": "beginner",
  "learningResourceType": "Quiz",
  "numberOfQuestions": test.questions.length,
  "author": {
    "@type": "Organization",
    "name": "JudySylph"
  },
  "provider": {
    "@type": "Organization",
    "name": "JudySylph",
    "url": "https://judysylph.com"
  }
};
---

<Layout title={pageTitle} description={pageDescription} jsonLd={jsonLd}>
  <div class="max-w-2xl mx-auto px-4 py-8">
    <!-- Test Header -->
    <div class="text-center mb-8">
      <div class="text-6xl mb-4">{test.emoji}</div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
        {test.title}
      </h1>
      <p class="text-gray-600 dark:text-gray-400">
        {test.description}
      </p>
    </div>

    <!-- Questions Container -->
    <div id="test-container" data-test-slug={test.slug} data-lang={lang}>
      {test.questions.map((q, index) => (
        <div class={`question-slide ${index === 0 ? '' : 'hidden'}`} data-index={index}>
          <Question
            questionNumber={index + 1}
            totalQuestions={test.questions.length}
            question={q.question}
            choices={q.choices}
            lang={lang}
          />

        </div>
      ))}
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="hidden text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary-500 border-t-transparent"></div>
      <p class="mt-4 text-gray-600 dark:text-gray-400">Analyzing your results...</p>
    </div>

    <!-- SEO Content -->
    <TestSeoContent
      title={test.title}
      description={test.description}
      emoji={test.emoji}
      questionCount={test.questions.length}
      resultCount={test.results.length}
      lang={lang}
      slug={slug}
    />
  </div>
</Layout>

<script define:vars={{ testData: test }}>
  const container = document.getElementById('test-container');
  const loadingState = document.getElementById('loading-state');
  const slug = container.dataset.testSlug;
  const lang = container.dataset.lang;
  const STORAGE_KEY = `test_progress_${slug}`;

  let currentQuestion = 0;
  const totalQuestions = testData.questions.length;
  const scores = {};

  // Initialize scores
  testData.results.forEach(r => {
    scores[r.type] = 0;
  });

  // Restore progress from localStorage
  function restoreProgress() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        const data = JSON.parse(saved);
        // Check if saved within 24 hours
        if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
          currentQuestion = data.currentQuestion;
          Object.assign(scores, data.scores);

          // Show resume dialog
          if (currentQuestion > 0) {
            const resume = confirm(
              lang === 'ko'
                ? `이전에 ${currentQuestion}번 문항까지 진행하셨습니다. 이어서 하시겠습니까?`
                : `You previously completed ${currentQuestion} questions. Would you like to continue?`
            );
            if (resume) {
              // Show the current question
              document.querySelectorAll('.question-slide').forEach((slide, i) => {
                slide.classList.toggle('hidden', i !== currentQuestion);
              });
            } else {
              // Reset progress
              currentQuestion = 0;
              testData.results.forEach(r => { scores[r.type] = 0; });
              localStorage.removeItem(STORAGE_KEY);
            }
          }
        } else {
          localStorage.removeItem(STORAGE_KEY);
        }
      }
    } catch (e) {
      console.error('Failed to restore progress:', e);
    }
  }

  // Save progress to localStorage
  function saveProgress() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        currentQuestion,
        scores,
        timestamp: Date.now()
      }));
    } catch (e) {
      console.error('Failed to save progress:', e);
    }
  }

  // Clear progress on completion
  function clearProgress() {
    localStorage.removeItem(STORAGE_KEY);
  }

  // Restore on load
  restoreProgress();

  // GA: Track test start
  if (typeof gtag !== 'undefined') {
    gtag('event', 'test_start', {
      event_category: 'test',
      event_label: slug,
      test_name: testData.title
    });
  }

  // Track recently viewed tests
  try {
    const recentKey = 'recent_tests';
    const recent = JSON.parse(localStorage.getItem(recentKey) || '[]');
    const testInfo = { slug, title: testData.title, emoji: testData.emoji, timestamp: Date.now() };
    const filtered = recent.filter(t => t.slug !== slug);
    filtered.unshift(testInfo);
    localStorage.setItem(recentKey, JSON.stringify(filtered.slice(0, 10)));
  } catch (e) {
    console.error('Failed to save recent test:', e);
  }

  // Handle choice selection
  document.querySelectorAll('.choice-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const button = e.currentTarget;
      const choiceScores = JSON.parse(button.dataset.scores);

      // Add scores
      for (const [type, score] of Object.entries(choiceScores)) {
        if (scores[type] !== undefined) {
          scores[type] += score;
        }
      }

      // Highlight selected
      const parent = button.closest('.question-container');
      parent.querySelectorAll('.choice-btn').forEach(b => {
        b.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/30');
      });
      button.classList.add('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/30');

      // Move to next question after delay
      setTimeout(() => {
        if (currentQuestion < totalQuestions - 1) {
          // Hide current
          document.querySelectorAll('.question-slide')[currentQuestion].classList.add('hidden');
          currentQuestion++;
          // Show next
          document.querySelectorAll('.question-slide')[currentQuestion].classList.remove('hidden');
          // Save progress
          saveProgress();
          // Scroll to top
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
          // Clear progress on completion
          clearProgress();
          // Show loading
          container.classList.add('hidden');
          loadingState.classList.remove('hidden');

          // Calculate result
          let maxType = '';
          let maxScore = -Infinity;
          for (const [type, score] of Object.entries(scores)) {
            if (score > maxScore) {
              maxScore = score;
              maxType = type;
            }
          }

          // GA: Track test complete
          if (typeof gtag !== 'undefined') {
            gtag('event', 'test_complete', {
              event_category: 'test',
              event_label: slug,
              test_name: testData.title,
              result_type: maxType
            });
          }

          // Redirect to result page
          setTimeout(() => {
            window.location.href = `/${lang}/result/${slug}/${maxType}`;
          }, 1500);
        }
      }, 300);
    });
  });
</script>

<style>
  .question-slide {
    animation: fadeIn 0.3s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
